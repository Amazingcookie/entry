<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>js13k 2019</title>
  </head>
  <body>
        <canvas class="zdog-canvas" id="game" width="960" height="540"></canvas>
        <script src="zdog.dist.min.js"></script>

        <!-- Color pallete: https://www.aremycolorsaccessible.com/palette?colors=%23223e32&colors=%239db800&colors=%23b3dd52&colors=%2304bf00&colors=%23015d00 -->

        <script>
            x=game.getContext`2d`;
            level=5; //0 is main menu, everything higher is levels, lower is states
            var playerx = 0; var playery = 0;
            var playermovex = 0; var playermovey = 1;
            var horborder = 200; var flipy = 9000; var flipped = 1;
            var paused = false;
            var direction = 1; var cameray = 0;
            const TAU = Zdog.TAU
            obstacle = []; obstacle[0] = 0; 
            shakex = 0; shakey = 0; shakeduration = 0;

            create();
            setInterval(e=>{ step(false) },33);
            onkeydown=e=>{ keypress(e.key); }

            //https://stackoverflow.com/a/19303725
            var seed = 1;
            function random() {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            }

            function odd(num) { return num % 2;}

            function create() {

                // create illo
                illo = new Zdog.Illustration({
                    // set canvas with selector
                    element: '.zdog-canvas',
                    dragRotate: true,
                    zoom: 2,
                    rotate: {x: -(TAU/16), y: TAU/16},
                    onPrerender: function(ctx) {
                        ctx.beginPath();
                        ctx.rect(-1080, -1080, 1080*2, 1080*2);
                        ctx.fillStyle = "#223e32";
                        ctx.fill();
                    },
                });

                player = new Zdog.Group({
                    addTo: illo,
                    transform: {z: 25}
                });

                var body = new Zdog.Shape({
                    addTo: player,
                    stroke: 24,
                    color: '#04bf00',
                });

                var eyes = new Zdog.Shape({
                    addTo: player,
                    stroke: 5,
                    color: '#fff',
                    translate: {z: 5},
                    path: [ //QQQ Don't make them so long but 
                        { x: -6, y: -10 },          // start at top left
                        { x: -6, y: 0 },          // line to top right
                        { move: { x: 6, y: -10 } }, // move to bottom left
                        { x: 6, y: 0 },          // line to bottom right
                    ],
                });

                var legs = new Zdog.Shape({
                    addTo: player,
                    stroke: 5,
                    color: '#04bf00',
                    translate: {y: 16, z: 5},
                    path: [ //QQQ Don't make them so long but 
                        { x: -6, y: -10 },          // left leg at body
                        { x: -6, y: 0 },          // to knee
                        { x: -10, y: 0 },          // to toes
                        { move: { x: 6, y: -10 } }, // right leg
                        { x: 6, y: 0 },          // to knee
                        { x: 10, y: 0 },          // to toes
                    ],
                });

                var border = new Zdog.Shape({
                    addTo: illo,
                    stroke: 8,
                    color: "#9db800",
                    path: [ //QQQ Don't make them so long but 
                        { x: -horborder-10, y: -1000 },          // start at top left
                        { x: -horborder-10, y: 1000 },          // line to top right
                        { move: { x: horborder+10, y: -1000 } }, // move to bottom left
                        { x: horborder+10, y: 1000 },          // line to bottom right
                    ],
                });

                loadlevel(level);

                draw(); //Need to disable manual rotation
            }

            function loadlevel(lvlnumber) {
                //Clean up
                level = lvlnumber;
                seed = 1000*lvlnumber
                if (obstacle.length > 1)
                {
                    for (var i = 0; i == obstacle.length; i++)
                    {
                        obstacle[i].remove();
                    }
                    playerx = 0; playery = 0; playermovex = 0; playermovey = 0;
                }
                //Build new
                direction = 1;
                var amount = (lvlnumber*2) + 1

                for (var i = 0; i != amount; i++)
                {
                    var obstaclex = random() * (horborder - -horborder) + -horborder;
                    var obstacley = i*50-direction;
                    var front = (random() >= 0.5);
                    var clr = '#015d00';
                    if (front == true) {clr = "#b3dd52"}
                        obstacle[i] = new Zdog.Box({
                        addTo: illo,
                        width: 32,
                        height: 32*3,
                        frontFace: false, backFace: false,
                        depth: 8,
                        stroke: 8,
                        cornerRadius: 20,
                        color: clr,
                        translate: {x: obstaclex, y: obstacley, z: (front * 50) -25}
                    });
                    obstacle[i].colliding = false;
                }

                flipy = i*50-direction;

                console.log("Loaded level "+lvlnumber.toString())
            }

            function step(framestep) {
                if (paused && framestep == false) {return;}
                cameray -= direction;

                playerx += playermovex/4;
                if (playerx > horborder) {playerx = horborder; playermovex = 0;}
                if (playerx < -horborder) {playerx = -horborder; playermovex = 0}
                playery += playermovey;

                if (flipped == -1) 
                {
                    illo.rotate.x  -(TAU/16)*9;
                } 

                if (playery > flipy)
                {
                    playery = flipy;
                    flipped = -1;
                    playermovey = -1;
                }
                
                for (var i = 0; i != obstacle.length; i++)
                {
                    xx = obstacle[i].translate.x; 
                    yy = obstacle[i].translate.y;
                    zz = obstacle[i].translate.z;
                    w = obstacle[i].width-5; h = obstacle[i].height-20;
                    //console.log(i.toString() + "i " + xx.toString() + "x "+ yy.toString() + "y "+ w.toString() + "w " + h.toString() + "h ");

                    if (playerx > xx - w && playerx < xx + w && playery > yy - h && playery < yy + h && zz == 25)
                    {
                        if (obstacle[i].colliding == false)
                        {
                            console.log("Collision detected with "+i.toString());
                            obstacle[i].colliding = true;
                            
                            if (playermovex > 0) {shakex = 5;} else if (playermovex < 0) {shakex = -5}
                            playermovex = 0; playermovey = 1*flipped; shakeduration = 2;
                        }
                    }
                    else if (obstacle[i].colliding == true)
                    {
                        console.log("Collision ended with "+i.toString());
                        obstacle[i].colliding = false;

                        //QQQ Push tile to background.
                    }
                }

                draw();
            }

            function keypress(key) {
                console.log(key);

                if (key == "Escape")
                {
                    paused = !paused;
                }
                
                if (paused) 
                {
                    if (key != "f") //Frame skip QQQ
                        {return;}
                        else
                        {step(true);}
                    }
                
                if ((key == "ArrowLeft" || key == "a" || key == "q") && playermovex == 0) //Left or A or Q
                {
                    playermovex = -8;
                    playermovey = 0;
                    //If there's something you are colliding with it should end here
                }
                if ((key == "ArrowRight" || key == "d") && playermovex == 0)
                {
                    playermovex = 8;
                    playermovey = 0;
                    //If there's something you are colliding with it should end here
                }
                if ((key == "ArrowUp" || key == "w" || key == "z"))
                {
                    playermovex = 0;
                    if (flipped == 1)
                    {
                        playermovey = 0.5*flipped;
                    }
                    else
                    {
                        playermovey = 3*flipped;
                    }
                }
                if ((key == "ArrowDown" || key == "s"))
                {
                    playermovex = 0;
                    if (flipped == 1)
                    {
                        playermovey = 3*flipped;
                    }
                    else
                    {
                        playermovey = 0.5*flipped;
                    }
                }
            }

            function draw() {
                player.translate = {x: playerx, y: playery}
                player.rotate = { y: -playermovex*0.15, x: -playermovey*0.1} //x and y swap here
                cameray = -player.translate.y*0.92; //Probably not the perfect number yet, but a pretty close approximation QQQ
                if (shakeduration > 0) 
                {
                    console.log("Shaking "+shakeduration.toString() + " " + cameray.toString())
                    illo.translate = {x: 0 + shakex, y: cameray + shakey}; 
                    shakeduration -= 1;
                } else {
                    illo.translate = {x: 0, y: cameray}; 
                }

                illo.updateRenderGraph();
            }

            /* FPS qqq*/ 
            const times = [];
            let fps;

            function refreshLoop() {
            window.requestAnimationFrame(() => {
                const now = performance.now();
                while (times.length > 0 && times[0] <= now - 1000) {
                    times.shift();
                }
                times.push(now);
                fps = times.length;
                document.getElementById("fps-display").innerHTML = fps.toString() + " fps";
                document.getElementById("seed-display").innerHTML = seed.toString() + " seed";
                document.getElementById("level-display").innerHTML = level.toString() + " level";
                document.getElementById("cam-display").innerHTML = illo.rotate.x.toString() + "x  " + illo.rotate.y.toString() + "y  " + illo.rotate.x.toString() + "z  " + TAU.toString() + "tau";
                refreshLoop();
            });
            }

            refreshLoop();

        </script>
        <p>
            To do:
            - Obstacles
            - Colliding behavior
            - Flipping
            - "Back"

            <b>Deadline 13 September!</b>
        </p>
        <div id="fps-display">N/A FPS</div> <div id="seed-display">N/A Random Seed</div> <div id="level-display">N/A Level</div> <div id="cam-display">N/A Camera</div>
  </body>
</html>