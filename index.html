<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>js13k 2019</title>
  </head>
  <body>
        <canvas class="zdog-canvas" id="game"></canvas>
        <script src="zdog.dist.min.js"></script>
        <link rel="stylesheet" href="style.css">

        <!-- Color pallete: https://www.aremycolorsaccessible.com/palette?colors=%23223e32&colors=%239db800&colors=%23b3dd52&colors=%2304bf00&colors=%23015d00 -->

        <script>
            x=game.getContext`2d`;
            level=5; //0 is main menu, everything higher is levels, lower is states
            playerx = 0; playery = 0;
            playermovex = 0; playermovey = 1;
            horborder = 200; flipy = 9000; flipped = 1;
            paused = false;
            direction = 1; cameray = 0;
            const TAU = Zdog.TAU
            obstacle = []; obstacle[0] = 0; 
            shakex = 0; shakey = 0; shakeduration = 0;
            bgcolor = "#223e32";
            const times = []; let fps;

            create();
            setInterval(e=>{ step(false) },15);
            onkeydown=e=>{ keypress(e.key); }

            //https://stackoverflow.com/a/19303725
            var seed = 1;
            function random() {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            }

            function create() {

                // create illo
                illo = new Zdog.Illustration({
                    element: '.zdog-canvas',
                    dragRotate: true,
                    zoom: 2,
                    resize: true,
                    rotate: {x: -(TAU/16), y: TAU/16},
                    onPrerender: function(ctx) {
                        ctx.beginPath();
                        ctx.rect(-1080, -1080, 1080*2, 1080*2);
                        ctx.fillStyle = bgcolor;
                        ctx.fill();
                    },
                });

                player = new Zdog.Group({
                    addTo: illo,
                    transform: {z: 25}
                });

                var body = new Zdog.Shape({
                    addTo: player,
                    stroke: 24,
                    color: '#04bf00',
                });

                var eyes = new Zdog.Shape({
                    addTo: player,
                    stroke: 5,
                    color: '#fff',
                    translate: {z: 5},
                    path: [
                        { x: -6, y: -10 },          // start at top left
                        { x: -6, y: 0 },          // line to top right
                        { move: { x: 6, y: -10 } }, // move to bottom left
                        { x: 6, y: 0 },          // line to bottom right
                    ],
                });

                var legs = new Zdog.Shape({
                    addTo: player,
                    stroke: 5,
                    color: '#04bf00',
                    translate: {y: 16, z: 5},
                    path: [
                        { x: -6, y: -10 },          // left leg at body
                        { x: -6, y: 0 },          // to knee
                        { x: -10, y: 0 },          // to toes
                        { move: { x: 6, y: -10 } }, // right leg
                        { x: 6, y: 0 },          // to knee
                        { x: 10, y: 0 },          // to toes
                    ],
                });

                var border = new Zdog.Shape({
                    addTo: illo,
                    stroke: 8,
                    color: "#9db800",
                    path: [ //QQQ Don't make them so long but move with either player or camera
                        { x: -horborder-10, y: -1000 },          // start at top left
                        { x: -horborder-10, y: 1000 },          // line to top right
                        { move: { x: horborder+10, y: -1000 } }, // move to bottom left
                        { x: horborder+10, y: 1000 },          // line to bottom right
                    ],
                });

                loadlevel(level);

                draw(); //Need to disable manual rotation
            }

            function loadlevel(lvlnumber) {
                //Clean up
                level = lvlnumber;
                seed = 1000*lvlnumber
                if (obstacle.length > 1)
                {
                    for (var i = 0; i == obstacle.length; i++)
                    {
                        obstacle[i].remove();
                    }
                }
                flipped = 1;
                playerx = 0; playery = 0; playermovex = 0; playermovey = 1;

                //Build new
                direction = 1;
                var amount = (lvlnumber*2) + 1

                for (var i = 0; i != amount; i++)
                {
                    var obstaclex = random() * (horborder - -horborder) + -horborder;
                    var obstacley = i*50-direction;
                    var front = (random() >= 0.5);
                    var clr = "#015d00";
                    if (front == true) {clr = "#b3dd52"}
                        obstacle[i] = new Zdog.Box({
                        addTo: illo,
                        width: 32,
                        height: 32*3,
                        frontFace: false, backFace: false,
                        depth: 8,
                        stroke: 8,
                        cornerRadius: 20,
                        color: clr,
                        translate: {x: obstaclex, y: obstacley, z: (front * 50) -25}
                    });
                    obstacle[i].colliding = false;
                }

                flipy = i*50-direction;

                console.log("Loaded level "+lvlnumber.toString())
            }

            function step(framestep) {

                const now = performance.now();
                while (times.length > 0 && times[0] <= now - 1000) {
                    times.shift();
                }
                times.push(now);
                fps = times.length;
                document.getElementById("fps-display").innerHTML = fps.toString() + " fps";
                document.getElementById("seed-display").innerHTML = seed.toString() + " seed";
                document.getElementById("level-display").innerHTML = level.toString() + " level";
                document.getElementById("cam-display").innerHTML = illo.rotate.x.toString() + "x  " + illo.rotate.y.toString() + "y  " + illo.rotate.x.toString() + "z  " + TAU.toString() + "tau";

                if (paused && framestep == false) {return;}
                cameray -= direction;

                if (flipped == -1) 
                    {
                        if (illo.rotate.x < (TAU/16)*7)
                        {
                            illo.rotate.x += (TAU/16);
                            bgcolor = "#A7C06D";
                            console.log("Flipping...")
                        }
                    } 

                for (var j = 0; j != 4; j += 1) //So we're doing most of the step loop four times for smoother movement! They did it in Super Mario 64, so can I!
                {
                    playerx += playermovex/4;
                    if (playerx > horborder) {playerx = horborder; playermovex = 0;}
                    if (playerx < -horborder) {playerx = -horborder; playermovex = 0}
                    playery += playermovey/4;

                    if (playery > flipy)
                    {
                        playery = flipy;
                        flipped = -1;
                        playermovey = -1;
                    }
                    
                    for (var i = 0; i != obstacle.length; i++)
                    {
                        xx = obstacle[i].translate.x; 
                        yy = obstacle[i].translate.y;
                        zz = obstacle[i].translate.z;
                        w = obstacle[i].width-5; h = obstacle[i].height-20;

                        if ( ((flipped == 1 && zz == 25) || (flipped == -1 && zz == -25)) && playerx > xx - w && playerx < xx + w && playery > yy - h && playery < yy + h)
                        {
                            if (obstacle[i].colliding == false)
                            { //Collision enter
                                console.log("Collision detected with "+i.toString());
                                obstacle[i].colliding = true;
                                
                                if (playermovex > 0) {shakex = 5;} else if (playermovex < 0) {shakex = -5} else {shakex = 0}
                                playermovex = 0; playermovey = 1*flipped; shakeduration = 2;
                            }
                        }
                        else if (obstacle[i].colliding == true)
                        { //Collision leave
                            console.log("Collision ended with "+i.toString());
                            obstacle[i].colliding = false;

                            if (obstacle[i].translate.z == 25) //In foreground
                            {
                                obstacle[i].translate.z = -25; obstacle[i].color = "#015d00";
                            } else { //In background
                                obstacle[i].translate.z = 25; obstacle[i].color = "#b3dd52"  ;
                            }
                        }
                    }
                }

                draw();
            }

            function keypress(key) {
                console.log(key);

                if (key == "Escape")
                {
                    paused = !paused;
                }
                
                if (paused) 
                {
                    if (key == "f") //Frame skip QQQ
                        {step(true);}
                    if (key == " ")
                    {
                        draw() //Allow rotation
                    }
                    else
                        {return;}
                }

                var delta = 0; 
                if (key == "ArrowLeft" || key == "a" || key == "q") {delta = -1}
                if (key == "ArrowRight" || key == "d") {delta = 1}
                
                if (delta == -1 && playermovex == 0) //Left or A or Q
                {
                    playermovex = -8;
                    playermovey = 0;
                    //If there's something you are colliding with it should end here
                }
                if (delta == 1 && playermovex == 0)
                {
                    playermovex = 8;
                    playermovey = 0;
                    //If there's something you are colliding with it should end here
                }
                if ((key == "ArrowUp" || key == "w" || key == "z"))
                {
                    playermovex = 0;
                    playermovey = 0.5*flipped;
                }
                if ((key == "ArrowDown" || key == "s"))
                {
                    playermovex = 0;
                    playermovey = 3*flipped;
                }
            }

            function draw() {
                player.translate = {x: playerx, y: playery}
                var yoff = 0; if (flipped == -1) {yoff = -TAU/2}
                player.rotate = { y: -(playermovex)*0.08, x: -(playermovey*0.15*flipped)+yoff} //x and y swap here
                cameray = -flipped*player.translate.y*0.935; // 15/16 
                if (shakeduration > 0) //QQQ Remove shake counter timing away from this function.
                {
                    console.log("Shaking "+shakeduration.toString() + " " + cameray.toString())
                    illo.translate = {x: 0 + shakex, y: cameray + shakey}; 
                    shakeduration -= 1;
                } else {
                    illo.translate = {x: 0, y: cameray}; 
                }

                illo.updateRenderGraph();
            }

            //Utility functions
            window.addEventListener("resize", function() {
                resize();
            });

            function resize() {
                var canvas = document.getElementById('game');
                if (window.innerWidth > 850 && window.innerHeight > 600) {illo.zoom = 2}
                else if (window.innerWidth > 600 && window.innerHeight > 400) {illo.zoom = 1.5}
                else {illo.zoom = 1}
                console.log("Resizing... ");
                draw();
            }

        </script>
        <p class = "debug">
            To do:
            - Collision leave behavior (with fancier animation, bouncing into the background)
            - Flipping (fix camera behavior, bottom trampoline using arced lines)
            - Interface (with skewed overlay text)
            - Title screen (text animation), level select
            - Win/fail states
            - Using delta time
            - Touch screen/swipe support so I can compete in the Mobile category
            - Optimization

            <b>Deadline 13 September!</b>

            Credits
            Game by Tom Hermans
            Zdog by Metafizzy
            Tweetworks by xem
        </p>
        <div id="fps-display">N/A FPS</div> <div id="seed-display">N/A Random Seed</div> <div id="level-display">N/A Level</div> <div id="cam-display">N/A Camera</div>
  </body>
</html>