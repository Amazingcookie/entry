x=game.getContext`2d`,level=5,playerx=0,playery=0,playermovex=0,playermovey=1,horborder=200,flipy=9e3,flipped=1,paused=!1,direction=1,cameray=0;const TAU=Zdog.TAU;obstacle=[],obstacle[0]=0,shakex=0,shakey=0,shakeduration=0,bgcolor="#223e32";const times=[];let fps;create(),setInterval(e=>{step(!1)},15),onkeydown=(e=>{input(e.key)});let pageWidth=window.innerWidth||document.body.clientWidth,treshold=Math.max(1,Math.floor(.01*pageWidth)),touchstartX=0,touchstartY=0,touchendX=0,touchendY=0;const limit=Math.tan(.375*Math.PI),gestureZone=document.getElementById("game");gestureZone.addEventListener("touchstart",function(e){touchstartX=e.changedTouches[0].screenX,touchstartY=e.changedTouches[0].screenY},!1),gestureZone.addEventListener("touchend",function(e){touchendX=e.changedTouches[0].screenX,touchendY=e.changedTouches[0].screenY,handleGesture(e)},!1);var seed=1;function random(){var e=1e4*Math.sin(seed++);return e-Math.floor(e)}function create(){illo=new Zdog.Illustration({element:".zdog-canvas",dragRotate:!1,zoom:2,resize:!0,rotate:{x:-TAU/16,y:TAU/16},onPrerender:function(e){e.beginPath(),e.rect(-1080,-1080,2160,2160),e.fillStyle=bgcolor,e.fill()}}),player=new Zdog.Group({addTo:illo,transform:{z:25}});new Zdog.Shape({addTo:player,stroke:24,color:"#04bf00"}),new Zdog.Shape({addTo:player,stroke:5,color:"#fff",translate:{z:5},path:[{x:-6,y:-10},{x:-6,y:0},{move:{x:6,y:-10}},{x:6,y:0}]}),new Zdog.Shape({addTo:player,stroke:5,color:"#04bf00",translate:{y:16,z:5},path:[{x:-6,y:-10},{x:-6,y:0},{x:-10,y:0},{move:{x:6,y:-10}},{x:6,y:0},{x:10,y:0}]}),new Zdog.Shape({addTo:illo,stroke:8,color:"#9db800",path:[{x:-horborder-10,y:-1e3},{x:-horborder-10,y:1e3},{move:{x:horborder+10,y:-1e3}},{x:horborder+10,y:1e3}]});resize(),loadlevel(level),draw()}function loadlevel(e){if(level=e,seed=1e3*e,obstacle.length>1)for(var o=0;o==obstacle.length;o++)obstacle[o].remove();flipped=1,playerx=0,playery=0,playermovex=0,playermovey=1,direction=1;var t=2*e+1;for(o=0;o!=t;o++){var r=random()*(horborder- -horborder)-horborder,a=50*o-direction,l=random()>=.5,n="#015d00";1==l&&(n="#b3dd52"),obstacle[o]=new Zdog.Box({addTo:illo,width:32,height:96,frontFace:!1,backFace:!1,depth:8,stroke:8,cornerRadius:20,color:n,translate:{x:r,y:a,z:50*l-25}}),obstacle[o].colliding=!1}flipy=50*o-direction,console.log("Loaded level "+e.toString())}function step(e){const o=performance.now();for(;times.length>0&&times[0]<=o-1e3;)times.shift();if(times.push(o),fps=times.length,document.getElementById("fps-display").innerHTML=fps.toString()+" fps",document.getElementById("seed-display").innerHTML=seed.toString()+" seed",document.getElementById("level-display").innerHTML=level.toString()+" level",document.getElementById("cam-display").innerHTML=illo.rotate.x.toString()+"x  "+illo.rotate.y.toString()+"y  "+illo.rotate.x.toString()+"z  "+TAU.toString()+"tau",!paused||0!=e){cameray-=direction,shakeduration>0?(illo.translate={x:0+shakex,y:cameray+shakey},shakeduration-=1):illo.translate={x:0,y:cameray},-1==flipped&&illo.rotate.x<TAU/16*7&&(illo.rotate.x+=TAU/16,bgcolor="#A7C06D",console.log("Flipping..."));for(var t=0;4!=t;t+=1){playerx+=playermovex/4,playerx>horborder&&(playerx=horborder,playermovex=0),playerx<-horborder&&(playerx=-horborder,playermovex=0),playery+=playermovey/4,playery>flipy&&(playery=flipy,flipped=-1,playermovey=-1);for(var r=0;r!=obstacle.length;r++)xx=obstacle[r].translate.x,yy=obstacle[r].translate.y,zz=obstacle[r].translate.z,w=obstacle[r].width-5,h=obstacle[r].height-20,(1==flipped&&25==zz||-1==flipped&&-25==zz)&&playerx>xx-w&&playerx<xx+w&&playery>yy-h&&playery<yy+h?0==obstacle[r].colliding&&(console.log("Collision detected with "+r.toString()),obstacle[r].colliding=!0,playermovex>0?shakex=5:playermovex<0?shakex=-5:shakex=0,playermovex=0,playermovey=1*flipped,shakeduration=2,sound([0,,.035,,.1449+.5*random(),.4918,,-.5252,,,,,,.034,,,,,1,,,,,.5+.3*random()])):1==obstacle[r].colliding&&(console.log("Collision ended with "+r.toString()),obstacle[r].colliding=!1,25==obstacle[r].translate.z?(obstacle[r].translate.z=-25,obstacle[r].color="#015d00"):(obstacle[r].translate.z=25,obstacle[r].color="#b3dd52"))}draw()}}function handleGesture(e){let o=touchendX-touchstartX,t=touchendY-touchstartY,r=Math.abs(o/t),a=Math.abs(t/o);Math.abs(o)>treshold||Math.abs(t)>treshold?(a<=limit&&input(o<0?"ArrowLeft":"ArrowRight"),r<=limit&&input(t<0?"ArrowUp":"ArrowDown")):input("Space")}function input(e){if(console.log(e),"Escape"==e&&(paused=!paused),paused){if("f"==e&&step(!0)," "!=e)return;draw()}var o=0;"ArrowLeft"!=e&&"a"!=e&&"q"!=e||(o=-1),"ArrowRight"!=e&&"d"!=e||(o=1),0!=o&&0==playermovex&&(playermovex=8*o,playermovey=0),"ArrowUp"!=e&&"w"!=e&&"z"!=e||(playermovex=0,playermovey=.5*flipped),"ArrowDown"!=e&&"s"!=e||(playermovex=0,playermovey=3*flipped)}function draw(){player.translate={x:playerx,y:playery};var e=0;-1==flipped&&(e=-TAU/2),player.rotate={y:.08*-playermovex,x:-.15*playermovey*flipped+e},cameray=-flipped*player.translate.y*.935-100,illo.updateRenderGraph()}function resize(){document.getElementById("game");window.innerWidth>850&&window.innerHeight>600?illo.zoom=2:window.innerWidth>600&&window.innerHeight>400?illo.zoom=1.5:window.innerWidth>400&&window.innerHeight>300?illo.zoom=1:illo.zoom=.9,draw()}function sound(e){var o=jsfxr(e),t=new Audio;t.src=o,t.play()}window.addEventListener("resize",function(){resize()});